workspace := ~/xod
# as of 0.15.0, it's __lib__ for user stuff
libdir := __lib__
userlib := $(workspace)/$libdir

.PHONY : all
all : derive-values install doc

.PHONY : derive-values
derive-values : lib/awg/values/boolean lib/awg/values/number lib/awg/values/boolean/any.cpp lib/awg/values/number/any.cpp lib/awg/values/boolean/patch.xodp lib/awg/values/number/patch.xodp lib/awg/values/boolean/patch.xodp lib/awg/values/number/patch.xodp

.PHONY : doc
doc : README.md NODES.md

NODES.md : always
	script/doc lib/awgrover > $@
	markdown $@ > NODES.html

XODNODES.md : always
	if [ -e xod-git ]; then \
		script/doc -h 3 xod-git/workspace/__lib__ > $@; \
		markdown $@ > XODNODES.html; \
	else \
		echo "Can't make $@, link 'xod-git' to git checkout"; \
	fi

README.md : always
	@# for node documentation
	awk '/"auto generated below here"/ {print}; /"auto generated below here"/,/^# / {next}; {print}' $@ > tmp_README.md
	script/doc -n -h 3 lib/awgrover >> tmp_README.md
	mv tmp_README.md README.md
	markdown $@ > README.html

.PHONY : always
always :


lib/awgrover/values/boolean lib/awgrover/values/number :
	mkdir -p $@

lib/awgrover/values/boolean/any.cpp lib/awgrover/values/number/any.cpp : lib/awgrover/values/text/any.cpp
	echo "// Generated by makefile from $<" > $@
	echo >> $@
	cat $< >> $@
	sed -i "s/input_text/input_$(shell basename $(shell dirname $@))/g" $@
lib/awgrover/values/boolean/patch.xodp lib/awgrover/values/number/patch.xodp : lib/awgrover/values/text/patch.xodp
	cp $< $@
	@# we assume all text -> number
	sed -i 's/text/$(shell basename $(shell dirname $@))/g' $@
	sed -i "s/input-string/input-$(shell basename $(shell dirname $@))/g" $@
	sed -i "s/output-string/output-$(shell basename $(shell dirname $@))/g" $@



.PHONY : install
install :
	rm $(workspace)/__lib__/awgrover 2>/dev/null || true
	ln -s `pwd`/__lib__/awgrover $(workspace)/lib/awgrover

